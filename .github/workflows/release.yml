name: Create Release

on:
  workflow_call:
    inputs:
      is_stable:
        required: true
        type: boolean

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v6
        with:
          name: DualSenseClient
          path: ./publish/

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath DualSenseClient.zip
          $size = [math]::Round((Get-Item DualSenseClient.zip).Length / 1MB, 2)
          Write-Host "ZIP archive created: $size MB"

      - name: Get release metadata
        id: metadata
        shell: pwsh
        run: |
          $sha = "${{ github.sha }}".Substring(0, 9)
          $date = Get-Date -Format "yyyy-MM-dd HH:mm UTC"
          $branch = "${{ github.ref_name }}"

          # Get comparison URL
          $latest = gh release list --exclude-pre-releases --limit 1 --json tagName --jq '.[0].tagName // empty' 2>$null
          if ($latest -and $latest -ne "nightly") {
              $compareUrl = "${{ github.server_url }}/${{ github.repository }}/compare/$latest...${{ github.sha }}"
          } else {
              $firstCommit = git rev-list --max-parents=0 HEAD
              $compareUrl = "${{ github.server_url }}/${{ github.repository }}/compare/$firstCommit...${{ github.sha }}"
          }

          # Output variables
          @{
              sha = $sha
              date = $date
              branch = $branch
              compare_url = $compareUrl
          }.GetEnumerator() | ForEach-Object {
              "$($_.Key)=$($_.Value)" >> $env:GITHUB_OUTPUT
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Stable Release
        if: inputs.is_stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $sha = "${{ steps.metadata.outputs.sha }}"

          # Create stable draft release
          gh release create $sha `
              DualSenseClient.zip `
              --draft `
              --generate-notes `
              --title "DualSense Client v$sha"

          Write-Host "Stable draft release created: $sha"

      - name: Create/Update Nightly Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag = "nightly"
          $notes = @"
          ðŸŒ™ **Nightly Build**

          This automated build contains the latest changes.
          âš ï¸ May contain bugs or incomplete features.

          **Build Info:**
          - ðŸ“… Date: ${{ steps.metadata.outputs.date }}
          - ðŸ“ Commit: ${{ steps.metadata.outputs.sha }}
          - ðŸŒ¿ Branch: ${{ steps.metadata.outputs.branch }}
          - ðŸ”— [View changes](${{ steps.metadata.outputs.compare_url }})
          "@

          # Delete existing nightly if it exists
          gh release view $tag --json id 2>$null | Out-Null
          if ($LASTEXITCODE -eq 0) {
              gh release delete $tag --yes --cleanup-tag
          }

          # Create new nightly
          gh release create $tag `
              DualSenseClient.zip `
              --prerelease `
              --title "DualSense Client (Nightly)" `
              --notes $notes `
              --target "${{ github.sha }}"

          Write-Host "Nightly release updated"