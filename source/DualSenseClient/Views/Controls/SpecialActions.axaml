<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ic="using:FluentIcons.Avalonia.Fluent"
             xmlns:vm="clr-namespace:DualSenseClient.ViewModels.Controls"
             xmlns:converters="clr-namespace:DualSenseClient.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="DualSenseClient.Views.Controls.SpecialActions"
             x:DataType="vm:SpecialActionsViewModel">
    <Design.DataContext>
        <vm:SpecialActionsViewModel />
    </Design.DataContext>

    <UserControl.Resources>
        <converters:ObjectToBooleanConverter x:Key="ObjectToBooleanConverter" />
    </UserControl.Resources>

    <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
            CornerRadius="8"
            Padding="24">
        <ScrollViewer>
            <StackPanel Spacing="24" MaxWidth="1200">
                <!-- Header -->
                <StackPanel Spacing="8">
                    <Grid ColumnDefinitions="Auto,*">
                        <ic:SymbolIcon Symbol="FlashSettings"
                                       FontSize="24"
                                       Margin="0,0,12,0"
                                       VerticalAlignment="Center" />
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="Special Actions"
                                       FontSize="20"
                                       FontWeight="SemiBold" />
                            <TextBlock Text="Create custom button combinations to trigger special controller actions"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       Margin="0,2,0,0" />
                        </StackPanel>
                    </Grid>
                    <Border Height="1"
                            Background="{DynamicResource DividerStrokeColorDefaultBrush}"
                            Margin="0,8,0,0" />
                </StackPanel>

                <!-- Main Content Grid -->
                <Grid ColumnDefinitions="2*,3*" ColumnSpacing="24">

                    <!-- Left Column: Configuration -->
                    <StackPanel Grid.Column="0" Spacing="16">

                        <!-- Action Configuration Card -->
                        <Border Background="{DynamicResource LayerFillColorDefaultBrush}"
                                CornerRadius="8"
                                Padding="20">
                            <StackPanel Spacing="16">
                                <Grid ColumnDefinitions="Auto,*">
                                    <ic:SymbolIcon Symbol="Settings"
                                                   FontSize="18"
                                                   Margin="0,0,10,0"
                                                   VerticalAlignment="Center" />
                                    <TextBlock Text="Action Configuration"
                                               FontSize="15"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"
                                               Grid.Column="1" />
                                </Grid>

                                <!-- Name Input -->
                                <StackPanel Spacing="6">
                                    <TextBlock Text="Action Name"
                                               FontWeight="Medium"
                                               FontSize="13" />
                                    <TextBox Watermark="e.g., Battery Check"
                                             Text="{Binding NewSpecialActionName}" />
                                </StackPanel>

                                <!-- Type Selection -->
                                <StackPanel Spacing="6">
                                    <TextBlock Text="Action Type"
                                               FontWeight="Medium"
                                               FontSize="13" />
                                    <ComboBox ItemsSource="{Binding SpecialActionTypes}"
                                              SelectedItem="{Binding SelectedSpecialActionType}"
                                              HorizontalAlignment="Stretch" />
                                </StackPanel>

                                <!-- Battery Indicator Type -->
                                <StackPanel Spacing="6"
                                            IsVisible="{Binding SelectedSpecialActionType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=BatteryIndicator, Mode=OneWay}">
                                    <TextBlock Text="Indicator Type"
                                               FontWeight="Medium"
                                               FontSize="13" />
                                    <ComboBox ItemsSource="{Binding BatteryIndicatorTypes}"
                                              SelectedItem="{Binding SelectedBatteryIndicatorType}"
                                              HorizontalAlignment="Stretch" />
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Button Selection Card -->
                        <Border Background="{DynamicResource LayerFillColorDefaultBrush}"
                                CornerRadius="8"
                                Padding="20">
                            <StackPanel Spacing="16">
                                <TextBlock Text="Button Combination"
                                           FontSize="15"
                                           FontWeight="SemiBold" />

                                <!-- Selected Buttons -->
                                <StackPanel Spacing="8">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Text="Selected Buttons"
                                                   FontWeight="Medium"
                                                   FontSize="13"
                                                   VerticalAlignment="Center" />
                                        <Button Grid.Column="1"
                                                Content="Clear"
                                                Command="{Binding ClearSelectedButtonsCommand}"
                                                FontSize="12"
                                                Padding="8,4"
                                                IsVisible="{Binding SelectedButtons.Count}" />
                                    </Grid>

                                    <Border Background="{DynamicResource ControlAltFillColorTertiaryBrush}"
                                            CornerRadius="6"
                                            Padding="12"
                                            MinHeight="80"
                                            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                            BorderThickness="1">
                                        <ScrollViewer MaxHeight="120">
                                            <ItemsControl ItemsSource="{Binding SelectedButtons}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal" />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{DynamicResource AccentFillColorDefaultBrush}"
                                                                CornerRadius="6"
                                                                Padding="10,6"
                                                                Margin="0,0,6,6">
                                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                                <TextBlock Text="{Binding .}"
                                                                           FontWeight="Medium"
                                                                           FontSize="13" />
                                                                <Button Command="{Binding $parent[UserControl].DataContext.RemoveButtonCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        Background="Transparent"
                                                                        BorderThickness="0"
                                                                        Padding="2"
                                                                        VerticalAlignment="Center">
                                                                    <ic:SymbolIcon Symbol="Dismiss" FontSize="12" />
                                                                </Button>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Border>
                                </StackPanel>

                                <!-- Available Buttons -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Available Buttons"
                                               FontWeight="Medium"
                                               FontSize="13" />
                                    <ScrollViewer MaxHeight="180">
                                        <ItemsControl ItemsSource="{Binding AvailableButtons}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal" />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Content="{Binding .}"
                                                            Command="{Binding $parent[UserControl].DataContext.SelectButtonCommand}"
                                                            CommandParameter="{Binding .}"
                                                            Padding="10,6"
                                                            Margin="0,0,6,6"
                                                            FontSize="13" />
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </StackPanel>

                                <!-- Action Buttons -->
                                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8" Margin="0,8,0,0">
                                    <Button Content="Add New"
                                            Command="{Binding AddSpecialActionCommand}"
                                            HorizontalAlignment="Stretch"
                                            Grid.Column="0"
                                            FontWeight="SemiBold">
                                        <Button.Styles>
                                            <Style Selector="Button">
                                                <Setter Property="Background" Value="{DynamicResource AccentFillColorDefaultBrush}" />
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                    <Button Content="Update"
                                            Command="{Binding UpdateSpecialActionCommand}"
                                            HorizontalAlignment="Stretch"
                                            Grid.Column="1"
                                            IsEnabled="{Binding SelectedSpecialAction, Converter={StaticResource ObjectToBooleanConverter}}">
                                        <Button.Styles>
                                            <Style Selector="Button">
                                                <Setter Property="Background" Value="{DynamicResource AccentFillColorDefaultBrush}" />
                                            </Style>
                                            <Style Selector="Button:disabled">
                                                <Setter Property="Opacity" Value="0.5" />
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                    <Button Content="Delete"
                                            Command="{Binding DeleteSpecialActionCommand}"
                                            HorizontalAlignment="Stretch"
                                            Grid.Column="2"
                                            IsEnabled="{Binding SelectedSpecialAction, Converter={StaticResource ObjectToBooleanConverter}}">
                                        <Button.Styles>
                                            <Style Selector="Button">
                                                <Setter Property="Background" Value="{DynamicResource SystemFillColorCriticalBrush}" />
                                            </Style>
                                            <Style Selector="Button:disabled">
                                                <Setter Property="Opacity" Value="0.5" />
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Right Column: Actions List & Preview -->
                    <StackPanel Grid.Column="1" Spacing="16">

                        <!-- Saved Actions Card -->
                        <Border Background="{DynamicResource LayerFillColorDefaultBrush}"
                                CornerRadius="8"
                                Padding="20">
                            <StackPanel Spacing="12">
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <ic:SymbolIcon Symbol="List"
                                                   FontSize="18"
                                                   Margin="0,0,10,0"
                                                   VerticalAlignment="Center" />
                                    <TextBlock Text="Saved Actions"
                                               FontSize="15"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"
                                               Grid.Column="1" />
                                    <Border Grid.Column="2"
                                            Background="{DynamicResource AccentFillColorDefaultBrush}"
                                            CornerRadius="12"
                                            Padding="8,4"
                                            VerticalAlignment="Center">
                                        <TextBlock Text="{Binding SpecialActions.Count}"
                                                   FontSize="12"
                                                   FontWeight="SemiBold" />
                                    </Border>
                                </Grid>

                                <ListBox ItemsSource="{Binding SpecialActions}"
                                         SelectedItem="{Binding SelectedSpecialAction}"
                                         SelectionMode="Single"
                                         MinHeight="300"
                                         MaxHeight="450"
                                         Background="Transparent">
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem">
                                            <Setter Property="Padding" Value="0" />
                                            <Setter Property="Margin" Value="0,0,0,8" />
                                        </Style>
                                    </ListBox.Styles>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                                    CornerRadius="6"
                                                    Padding="16"
                                                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                                    BorderThickness="1">
                                                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                                                    <!-- Name -->
                                                    <TextBlock Text="{Binding Name}"
                                                               FontWeight="SemiBold"
                                                               FontSize="14"
                                                               Grid.Row="0" />

                                                    <!-- Type & Indicator -->
                                                    <StackPanel Orientation="Horizontal" Spacing="12" Grid.Row="1">
                                                        <Border Background="{DynamicResource AccentFillColorSecondaryBrush}"
                                                                CornerRadius="4"
                                                                Padding="8,4">
                                                            <TextBlock Text="{Binding Type}"
                                                                       FontSize="11"
                                                                       FontWeight="Medium" />
                                                        </Border>
                                                        <Border Background="{DynamicResource ControlAltFillColorTertiaryBrush}"
                                                                CornerRadius="4"
                                                                Padding="8,4"
                                                                IsVisible="{Binding Settings.BatteryIndicatorType, Converter={StaticResource ObjectToBooleanConverter}}">
                                                            <TextBlock Text="{Binding Settings.BatteryIndicatorType}"
                                                                       FontSize="11"
                                                                       FontWeight="Medium" />
                                                        </Border>
                                                    </StackPanel>

                                                    <!-- Button Count -->
                                                    <StackPanel Orientation="Horizontal" Spacing="6" Grid.Row="2">
                                                        <ic:SymbolIcon Symbol="Keyboard"
                                                                       FontSize="14"
                                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                                        <TextBlock Text="{Binding Combination.Buttons.Count, StringFormat='{}{0} button(s)'}"
                                                                   FontSize="12"
                                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </Border>

                        <!-- Preview Card -->
                        <Border Background="{DynamicResource LayerFillColorDefaultBrush}"
                                CornerRadius="8"
                                Padding="20">
                            <StackPanel Spacing="12">
                                <Grid ColumnDefinitions="Auto,*">
                                    <ic:SymbolIcon Symbol="Eye"
                                                   FontSize="18"
                                                   Margin="0,0,10,0"
                                                   VerticalAlignment="Center" />
                                    <TextBlock Text="Preview"
                                               FontSize="15"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"
                                               Grid.Column="1" />
                                </Grid>

                                <Border Background="{DynamicResource ControlAltFillColorTertiaryBrush}"
                                        CornerRadius="6"
                                        Padding="16"
                                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                        BorderThickness="1">
                                    <StackPanel Spacing="10">
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                            <TextBlock Text="Name:"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            <TextBlock Text="{Binding NewSpecialActionName, TargetNullValue='(Not set)'}"
                                                       FontSize="13"
                                                       Grid.Column="1" />
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                            <TextBlock Text="Type:"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            <TextBlock Text="{Binding SelectedSpecialActionType}"
                                                       FontSize="13"
                                                       Grid.Column="1" />
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8"
                                              IsVisible="{Binding SelectedSpecialActionType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=BatteryIndicator, Mode=OneWay}">
                                            <TextBlock Text="Indicator:"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            <TextBlock Text="{Binding SelectedBatteryIndicatorType, TargetNullValue='(Not set)'}"
                                                       FontSize="13"
                                                       Grid.Column="1" />
                                        </Grid>
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                            <TextBlock Text="Buttons:"
                                                       FontWeight="SemiBold"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            <TextBlock Text="{Binding SelectedButtons.Count, StringFormat='{}{0} selected'}"
                                                       FontSize="13"
                                                       Grid.Column="1" />
                                        </Grid>
                                    </StackPanel>
                                </Border>

                                <Border Background="{DynamicResource AccentFillColorTertiaryBrush}"
                                        CornerRadius="6"
                                        Padding="12"
                                        BorderBrush="{DynamicResource AccentControlElevationBorderBrush}"
                                        BorderThickness="1">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ic:SymbolIcon Symbol="Info"
                                                       FontSize="16"
                                                       Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"
                                                       VerticalAlignment="Top"
                                                       Margin="0,2,0,0" />
                                        <TextBlock TextWrapping="Wrap"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                   Grid.Column="1">
                                            Configure your action above, select button combinations, then click "Add New" to save or select an existing action to update it.
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </ScrollViewer>
    </Border>
</UserControl>